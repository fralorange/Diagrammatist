<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:toolbox="clr-namespace:DiagramApp.Domain.Toolbox;assembly=DiagramApp.Domain"
             xmlns:figures="clr-namespace:DiagramApp.Domain.Canvas.Figures;assembly=DiagramApp.Domain"
             xmlns:wrappers="clr-namespace:DiagramApp.Client.ViewModels.Wrappers"
             xmlns:controls="clr-namespace:DiagramApp.Client.Controls"
             xmlns:viewmodel="clr-namespace:DiagramApp.Client.ViewModels"
             x:Class="DiagramApp.Client.MainView"
             x:DataType="viewmodel:MainViewModel"
             Title="">

    <ContentPage.MenuBarItems>
        <MenuBarItem Text="Файл">
            <MenuFlyoutItem Text="Создать"
                            Command="{Binding CreateCanvasCommand}">
                <MenuFlyoutItem.KeyboardAccelerators>
                    <KeyboardAccelerator Modifiers="Ctrl"
                                         Key="N"/>
                </MenuFlyoutItem.KeyboardAccelerators>
            </MenuFlyoutItem>
            <MenuFlyoutItem Text="Открыть"/>
            <MenuFlyoutSeparator/>
            <MenuFlyoutItem Text="Закрыть"
                            IsEnabled="False"/>
            <MenuFlyoutItem Text="Закрыть все"
                            IsEnabled="False"/>
            <MenuFlyoutItem Text="Сохранить"
                            IsEnabled="False"/>
            <MenuFlyoutItem Text="Сохранить как"
                            IsEnabled="False"/>
            <MenuFlyoutSeparator/>
            <MenuFlyoutItem Text="Выход"
                            Clicked="OnExitClicked"/>
        </MenuBarItem>
        <MenuBarItem Text="Редактирование">

        </MenuBarItem>
        <MenuBarItem Text="Вид">
            <MenuFlyoutItem Text="Приблизить"
                            Command="{Binding ZoomInCommand}"
                            IsEnabled="{Binding IsCanvasNotNull}"/>
            <MenuFlyoutItem Text="Отдалить"
                            Command="{Binding ZoomOutCommand}"
                            IsEnabled="{Binding IsCanvasNotNull}"/>
            <MenuFlyoutSeparator/>
            <MenuFlyoutItem Text="Сбросить вид"
                            Clicked="OnResetViewClicked"
                            IsEnabled="{Binding IsCanvasNotNull}"/>
        </MenuBarItem>
        <MenuBarItem Text="Справка">

        </MenuBarItem>
    </ContentPage.MenuBarItems>

    <Grid ColumnDefinitions="15*,70*,15*"
          RowDefinitions="15*,50*,35*"
          Padding="5, 0, 5, 15"
          RowSpacing="5"
          ColumnSpacing="5">
        
        <Frame Grid.ColumnSpan="3"
               Grid.Row="0"
               Padding="0">
            <StackLayout Orientation="Horizontal"
                         Spacing="5">
                <Grid RowDefinitions="*, Auto"
                      ColumnDefinitions="*"
                      RowSpacing="10"
                      Margin="10">
                    <HorizontalStackLayout Spacing="5">
                        <VerticalStackLayout Spacing="5"
                                             Padding="0">
                            <ImageButton Source="{AppThemeBinding Light=select.png, Dark=select_dark.png}"
                                         Command="{Binding ChangeControlsCommand}"
                                         CommandParameter="Select"
                                         Aspect="AspectFit"
                                         Style="{StaticResource Tool}"/>
                            <Label Text="Выбрать"
                                   Style="{StaticResource LabelControlName}"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                        <VerticalStackLayout Spacing="5"
                                             Padding="0">
                            <ImageButton Source="{AppThemeBinding Light=drag.png, Dark=drag_dark.png}"
                                         Command="{Binding ChangeControlsCommand}"
                                         CommandParameter="Drag"
                                         Aspect="AspectFit"
                                         Style="{StaticResource Tool}"/>
                            <Label Text="Двигать"
                                   Style="{StaticResource LabelControlName}"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                    </HorizontalStackLayout>
                    <Label Text="Управление"
                           Style="{StaticResource LabelControl}"
                           Grid.Row="1" 
                           Grid.ColumnSpan="2"
                           VerticalOptions="Center" 
                           HorizontalOptions="Center" />
                </Grid>
                <BoxView Style="{StaticResource VerticalSeparator}"/>
            </StackLayout>
        </Frame>

        <Frame Grid.Row="1"
               Grid.RowSpan="3"
               Grid.Column="0">
            
            <Grid RowDefinitions="Auto, Auto, *"
                  RowSpacing="10">
                <Label Grid.Row="0"
                       Text="Инструментарий"
                       HorizontalTextAlignment="Center"/>
                <Picker Grid.Row="1"
                        ItemsSource="{Binding ToolboxViewModel.Categories}"
                        SelectedItem="{Binding ToolboxViewModel.SelectedCategory}">
                    <Picker.Behaviors>
                        <toolkit:EventToCommandBehavior 
                            EventName="Loaded"
                            Command="{Binding ToolboxViewModel.LoadToolboxCommand}"/>
                        <toolkit:EventToCommandBehavior
                            EventName="SelectedIndexChanged"
                            Command="{Binding ToolboxViewModel.CategoryChangeCommand}"/>
                    </Picker.Behaviors>
                </Picker>
                <CollectionView Grid.Row="2"
                                SelectionMode="Single"
                                SelectionChanged="OnSelectionChanged"
                                ItemsSource="{Binding ToolboxViewModel.FilteredToolboxItems}">
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical" Span="3"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="toolbox:ToolboxItem">
                            <Grid Padding="10"
                                  RowDefinitions="Auto, Auto">
                                <Path Grid.Row="0"
                                      Data="{Binding PathData, Converter={StaticResource PathDataToGeometryConverter}}"
                                      Style="{StaticResource Shape}"/>
                                <!--<Label Grid.Row="1"
                                       Text="{Binding Name}"
                                       HorizontalTextAlignment="Center"/>-->
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>
            
        </Frame>

        <StackLayout Grid.Row="1" 
                     Grid.RowSpan="2" 
                     Grid.Column="1" 
                     Spacing="1"
                     Orientation="Vertical">

            <Frame x:Name="CanvasWindow" 
                   VerticalOptions="FillAndExpand">
                <controls:BindableScrollView x:Name="CanvasScrollWindow"
                                             HorizontalScrollBarVisibility="Always" 
                                             VerticalScrollBarVisibility="Always"  
                                             Orientation="Both"
                                             ScrollX="{Binding CurrentCanvas.Offset.X, Mode=OneWayToSource}"
                                             ScrollY="{Binding CurrentCanvas.Offset.Y, Mode=OneWayToSource}"
                                             Scroll="{Binding CurrentCanvas.Offset, Mode=OneWay}">
                    <AbsoluteLayout x:Name="FrameCanvasContainer" 
                                    WidthRequest="{Binding CurrentCanvas.ImaginaryWidth}" 
                                    HeightRequest="{Binding CurrentCanvas.ImaginaryHeight}">
                        
                        <Border Style="{StaticResource CanvasBorder}"
                                BackgroundColor="{Binding CurrentCanvas.Settings.Background, Converter={StaticResource BackgroundTypeToColorConverter}}"
                                AbsoluteLayout.LayoutBounds="0, 0, 1, 1"
                                AbsoluteLayout.LayoutFlags="All"
                                WidthRequest="{Binding CurrentCanvas.Settings.Width}"
                                HeightRequest="{Binding CurrentCanvas.Settings.Height}"
                                Scale="{Binding CurrentCanvas.Zoom}">
                            <Border.Triggers>
                                <DataTrigger Binding="{Binding IsCanvasNotNull}" TargetType="Border" Value="False">
                                    <Setter Property="Opacity" Value="0" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding IsCanvasNotNull}" TargetType="Border" Value="True">
                                    <Setter Property="Opacity" Value="1" />
                                </DataTrigger>
                            </Border.Triggers>
                            
                            <AbsoluteLayout x:Name="CanvasContent"
                                            BindableLayout.ItemsSource="{Binding CurrentCanvas.Figures}">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="figures:Figure">
                                        <!--Border will be used as selection grid for item l8r-->
                                        <Border StrokeThickness="0">
                                            <Path Data="{Binding PathData, Converter={StaticResource PathDataToGeometryConverter}}"
                                                  Style="{StaticResource CanvasShape}"/>
                                            <Border.GestureRecognizers>
                                                <PanGestureRecognizer PanUpdated="OnPanElementUpdated"/>
                                            </Border.GestureRecognizers>
                                        </Border>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                                <AbsoluteLayout.GestureRecognizers>
                                    <PointerGestureRecognizer PointerMoved="OnPointerMovedInsideCanvas"
                                                              PointerExited="OnPointerExitedFromCanvas"/>
                                </AbsoluteLayout.GestureRecognizers>
                            </AbsoluteLayout>
                        </Border>
                        
                        <AbsoluteLayout.GestureRecognizers>
                            <PanGestureRecognizer PanUpdated="OnPanCanvasUpdated"/>
                            <PointerGestureRecognizer PointerEntered="OnPointerEntered"/>
                        </AbsoluteLayout.GestureRecognizers>
                    </AbsoluteLayout>
                </controls:BindableScrollView>

            </Frame>
            
            <CollectionView ItemsLayout="HorizontalList"
                            ItemsSource="{Binding Canvases}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="wrappers:ObservableCanvas">
                        <Button Text="{Binding Settings.FileName}"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:MainViewModel}}, Path=SelectCanvasCommand}"
                                CommandParameter="{Binding .}"
                                Style="{StaticResource Tab}">
                            <FlyoutBase.ContextFlyout>
                                <MenuFlyout>
                                    <MenuFlyoutItem Text="Закрыть"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:MainViewModel}}, Path=CloseCanvasCommand}"
                                                    CommandParameter="{Binding .}"/>
                                </MenuFlyout>
                            </FlyoutBase.ContextFlyout>
                        </Button>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </StackLayout>

        <Frame Grid.Row="1"
               Grid.Column="2">

            <Grid RowDefinitions="Auto, *"
                  RowSpacing="10">
                <Label Grid.Row="0"
                       Text="Обозреватель объектов"
                       HorizontalTextAlignment="Center"/>
                <CollectionView Grid.Row="1"
                                ItemsSource="{Binding CurrentCanvas.Figures}"
                                ItemsLayout="VerticalList"
                                SelectionMode="Single">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="figures:Figure">
                            <Label Text="{Binding Name}">
                                <FlyoutBase.ContextFlyout>
                                    <!--Maybe put in different viewModel?-->
                                    <MenuFlyout>
                                        <MenuFlyoutItem Text="Удалить"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:MainViewModel}}, Path=DeleteItemFromCanvasCommand}"
                                                        CommandParameter="{Binding .}"/>
                                    </MenuFlyout>
                                </FlyoutBase.ContextFlyout>
                            </Label>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>

        </Frame>

        <Frame Grid.Row="2"
               Grid.RowSpan="2"
               Grid.Column="2">

            <StackLayout>
                <Entry IsReadOnly="True" 
                       Text="Properties"/>
            </StackLayout>

        </Frame>
    </Grid>
</ContentPage>
